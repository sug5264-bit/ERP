generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// 시스템 (System)
// ============================================================

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String    @unique
  passwordHash  String
  name          String
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  employeeId    String?   @unique
  employee      Employee? @relation(fields: [employeeId], references: [id])

  userRoles     UserRole[]
  auditLogs     AuditLog[]
  notifications Notification[]
  posts         Post[]
  postComments  PostComment[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id          String @id @default(cuid())
  module      String
  action      String
  description String?

  rolePermissions RolePermission[]

  @@unique([module, action])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId String
  roleId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model CommonCode {
  id        String  @id @default(cuid())
  groupCode String
  code      String
  nameKo    String
  nameEn    String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  parentId  String?
  extra     Json?

  parent   CommonCode?  @relation("CodeHierarchy", fields: [parentId], references: [id])
  children CommonCode[] @relation("CodeHierarchy")

  @@unique([groupCode, code])
  @@index([groupCode])
  @@map("common_codes")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  tableName String
  recordId  String?
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([tableName, recordId])
  @@index([createdAt])
  @@index([userId, action])
  @@map("audit_logs")
}

model Attachment {
  id           String   @id @default(cuid())
  fileName     String
  filePath     String
  fileSize     Int
  mimeType     String
  relatedTable String
  relatedId    String
  uploadedBy   String
  createdAt    DateTime @default(now())

  @@index([relatedTable, relatedId])
  @@map("attachments")
}

model Notification {
  id         String   @id @default(cuid())
  userId     String
  type       String
  title      String
  message    String
  isRead     Boolean  @default(false)
  relatedUrl String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model DocumentSequence {
  id        String @id @default(cuid())
  prefix    String
  yearMonth String
  lastSeq   Int    @default(0)

  @@unique([prefix, yearMonth])
  @@map("document_sequences")
}

// ============================================================
// 인사 (HR)
// ============================================================

model Department {
  id        String  @id @default(cuid())
  code      String  @unique
  name      String
  parentId  String?
  managerId String?
  level     Int     @default(1)
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  parent    Department?  @relation("DeptHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DeptHierarchy")

  employees        Employee[]
  purchaseRequests PurchaseRequest[]
  budgetHeaders    BudgetHeader[]
  projects         Project[]
  costCenters      CostCenter[]

  @@map("departments")
}

model Position {
  id        String  @id @default(cuid())
  code      String  @unique
  name      String
  level     Int     @default(1)
  sortOrder Int     @default(0)

  employees Employee[]

  @@map("positions")
}

enum EmployeeType {
  REGULAR
  CONTRACT
  DISPATCH
  INTERN
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  RESIGNED
}

model Employee {
  id           String         @id @default(cuid())
  employeeNo   String         @unique
  nameKo       String
  nameEn       String?
  departmentId String
  positionId   String
  joinDate     DateTime
  resignDate   DateTime?
  employeeType EmployeeType   @default(REGULAR)
  status       EmployeeStatus @default(ACTIVE)
  birthDate    DateTime?
  gender       String?
  phone        String?
  email        String?
  address      String?
  bankName     String?
  bankAccount  String?
  profileImage String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  department Department @relation(fields: [departmentId], references: [id])
  position   Position   @relation(fields: [positionId], references: [id])
  user       User?

  employeeHistories  EmployeeHistory[]
  payrollDetails     PayrollDetail[]
  attendances        Attendance[]
  leaves             Leave[]
  leaveBalances      LeaveBalance[]
  quotations         Quotation[]
  salesOrders        SalesOrder[]
  purchaseOrders     PurchaseOrder[]
  projectMembers     ProjectMember[]
  approvalDocDrafts  ApprovalDocument[] @relation("Drafter")
  approvalSteps      ApprovalStep[]
  vouchersCreated    Voucher[]          @relation("VoucherCreator")
  vouchersApproved   Voucher[]          @relation("VoucherApprover")

  @@index([departmentId])
  @@index([status])
  @@index([positionId])
  @@index([nameKo])
  @@index([email])
  @@map("employees")
}

model EmployeeHistory {
  id            String   @id @default(cuid())
  employeeId    String
  changeType    String
  fromDept      String?
  toDept        String?
  fromPosition  String?
  toPosition    String?
  effectiveDate DateTime
  reason        String?
  createdAt     DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("employee_histories")
}

model PayrollHeader {
  id        String   @id @default(cuid())
  payPeriod String
  payDate   DateTime
  status    String   @default("DRAFT")
  createdAt DateTime @default(now())

  details PayrollDetail[]

  @@unique([payPeriod])
  @@map("payroll_headers")
}

model PayrollDetail {
  id                  String  @id @default(cuid())
  payrollHeaderId     String
  employeeId          String
  baseSalary          Decimal @default(0) @db.Decimal(15, 2)
  overtimePay         Decimal @default(0) @db.Decimal(15, 2)
  bonusPay            Decimal @default(0) @db.Decimal(15, 2)
  mealAllowance       Decimal @default(0) @db.Decimal(15, 2)
  transportAllowance  Decimal @default(0) @db.Decimal(15, 2)
  nationalPension     Decimal @default(0) @db.Decimal(15, 2)
  healthInsurance     Decimal @default(0) @db.Decimal(15, 2)
  longTermCare        Decimal @default(0) @db.Decimal(15, 2)
  employmentInsurance Decimal @default(0) @db.Decimal(15, 2)
  incomeTax           Decimal @default(0) @db.Decimal(15, 2)
  localIncomeTax      Decimal @default(0) @db.Decimal(15, 2)
  totalEarnings       Decimal @default(0) @db.Decimal(15, 2)
  totalDeductions     Decimal @default(0) @db.Decimal(15, 2)
  netPay              Decimal @default(0) @db.Decimal(15, 2)

  payrollHeader PayrollHeader @relation(fields: [payrollHeaderId], references: [id])
  employee      Employee      @relation(fields: [employeeId], references: [id])

  @@unique([payrollHeaderId, employeeId])
  @@map("payroll_details")
}

enum AttendanceType {
  NORMAL
  LATE
  EARLY
  ABSENT
  BUSINESS
  REMOTE
}

model Attendance {
  id             String         @id @default(cuid())
  employeeId     String
  workDate       DateTime       @db.Date
  checkInTime    DateTime?
  checkOutTime   DateTime?
  workHours      Decimal?       @db.Decimal(4, 2)
  overtimeHours  Decimal?       @db.Decimal(4, 2)
  attendanceType AttendanceType @default(NORMAL)
  note           String?

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, workDate])
  @@map("attendances")
}

enum LeaveType {
  ANNUAL
  SICK
  FAMILY
  MATERNITY
  PARENTAL
  OFFICIAL
}

enum LeaveStatus {
  REQUESTED
  APPROVED
  REJECTED
  CANCELLED
}

model Leave {
  id         String      @id @default(cuid())
  employeeId String
  leaveType  LeaveType
  startDate  DateTime    @db.Date
  endDate    DateTime    @db.Date
  days       Decimal     @db.Decimal(4, 1)
  reason     String?
  status     LeaveStatus @default(REQUESTED)
  approvalId String?
  createdAt  DateTime    @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, startDate])
  @@index([status])
  @@map("leaves")
}

model LeaveBalance {
  id            String  @id @default(cuid())
  employeeId    String
  year          Int
  totalDays     Decimal @db.Decimal(4, 1)
  usedDays      Decimal @default(0) @db.Decimal(4, 1)
  remainingDays Decimal @db.Decimal(4, 1)

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, year])
  @@map("leave_balances")
}

model Recruitment {
  id            String   @id @default(cuid())
  title         String
  departmentId  String
  positionId    String
  description   String?  @db.Text
  requiredCount Int      @default(1)
  status        String   @default("OPEN")
  startDate     DateTime @db.Date
  endDate       DateTime @db.Date
  createdAt     DateTime @default(now())

  applicants Applicant[]

  @@map("recruitments")
}

model Applicant {
  id            String   @id @default(cuid())
  recruitmentId String
  name          String
  email         String
  phone         String?
  resumePath    String?
  status        String   @default("APPLIED")
  note          String?
  createdAt     DateTime @default(now())

  recruitment Recruitment @relation(fields: [recruitmentId], references: [id])

  @@index([recruitmentId])
  @@map("applicants")
}

// ============================================================
// 회계 (Accounting)
// ============================================================

model FiscalYear {
  id        String   @id @default(cuid())
  year      Int      @unique
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  isClosed  Boolean  @default(false)

  vouchers      Voucher[]
  budgetHeaders BudgetHeader[]

  @@map("fiscal_years")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model AccountSubject {
  id          String      @id @default(cuid())
  code        String      @unique
  nameKo      String
  nameEn      String?
  accountType AccountType
  level       Int         @default(1)
  parentId    String?
  isActive    Boolean     @default(true)
  taxRelated  Boolean     @default(false)

  parent   AccountSubject?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children AccountSubject[] @relation("AccountHierarchy")

  voucherDetails VoucherDetail[]
  budgetDetails  BudgetDetail[]

  @@map("account_subjects")
}

enum VoucherType {
  RECEIPT
  PAYMENT
  TRANSFER
  PURCHASE
  SALES
}

enum VoucherStatus {
  DRAFT
  APPROVED
  CONFIRMED
}

model Voucher {
  id           String        @id @default(cuid())
  voucherNo    String        @unique
  voucherDate  DateTime      @db.Date
  voucherType  VoucherType
  description  String?
  totalDebit   Decimal       @default(0) @db.Decimal(15, 2)
  totalCredit  Decimal       @default(0) @db.Decimal(15, 2)
  status       VoucherStatus @default(DRAFT)
  fiscalYearId String
  createdById  String
  approvedById String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  fiscalYear FiscalYear @relation(fields: [fiscalYearId], references: [id])
  createdBy  Employee   @relation("VoucherCreator", fields: [createdById], references: [id])
  approvedBy Employee?  @relation("VoucherApprover", fields: [approvedById], references: [id])

  details     VoucherDetail[]
  taxInvoices TaxInvoice[]

  @@index([voucherDate])
  @@index([voucherType])
  @@index([status, voucherDate])
  @@index([fiscalYearId])
  @@index([createdById])
  @@map("vouchers")
}

model VoucherDetail {
  id               String  @id @default(cuid())
  voucherId        String
  lineNo           Int
  accountSubjectId String
  debitAmount      Decimal @default(0) @db.Decimal(15, 2)
  creditAmount     Decimal @default(0) @db.Decimal(15, 2)
  partnerId        String?
  description      String?
  costCenterId     String?

  voucher        Voucher        @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  accountSubject AccountSubject @relation(fields: [accountSubjectId], references: [id])
  partner        Partner?       @relation(fields: [partnerId], references: [id])
  costCenter     CostCenter?    @relation(fields: [costCenterId], references: [id])

  @@index([voucherId])
  @@index([accountSubjectId])
  @@map("voucher_details")
}

model TaxInvoice {
  id                  String   @id @default(cuid())
  invoiceNo           String   @unique
  issueDate           DateTime @db.Date
  invoiceType         String
  supplierBizNo       String
  supplierName        String
  supplierCeo         String?
  supplierAddress     String?
  supplierBizType     String?
  supplierBizCategory String?
  buyerBizNo          String
  buyerName           String
  buyerCeo            String?
  buyerAddress        String?
  buyerBizType        String?
  buyerBizCategory    String?
  supplyAmount        Decimal  @db.Decimal(15, 2)
  taxAmount           Decimal  @db.Decimal(15, 2)
  totalAmount         Decimal  @db.Decimal(15, 2)
  transmissionStatus  String   @default("PENDING")
  ntsConfirmNo        String?
  voucherId           String?
  partnerId           String?
  createdAt           DateTime @default(now())

  voucher Voucher? @relation(fields: [voucherId], references: [id])
  partner Partner? @relation(fields: [partnerId], references: [id])
  items   TaxInvoiceItem[]

  @@index([issueDate])
  @@index([partnerId])
  @@index([transmissionStatus])
  @@map("tax_invoices")
}

model TaxInvoiceItem {
  id            String   @id @default(cuid())
  taxInvoiceId  String
  itemDate      DateTime @db.Date
  itemName      String
  specification String?
  qty           Decimal  @db.Decimal(10, 2)
  unitPrice     Decimal  @db.Decimal(15, 2)
  supplyAmount  Decimal  @db.Decimal(15, 2)
  taxAmount     Decimal  @db.Decimal(15, 2)

  taxInvoice TaxInvoice @relation(fields: [taxInvoiceId], references: [id], onDelete: Cascade)

  @@index([taxInvoiceId])
  @@map("tax_invoice_items")
}

model CostCenter {
  id           String @id @default(cuid())
  code         String @unique
  name         String
  departmentId String

  department     Department      @relation(fields: [departmentId], references: [id])
  voucherDetails VoucherDetail[]

  @@map("cost_centers")
}

model BudgetHeader {
  id           String @id @default(cuid())
  fiscalYearId String
  departmentId String
  status       String @default("DRAFT")

  fiscalYear FiscalYear   @relation(fields: [fiscalYearId], references: [id])
  department Department   @relation(fields: [departmentId], references: [id])
  details    BudgetDetail[]

  @@unique([fiscalYearId, departmentId])
  @@map("budget_headers")
}

model BudgetDetail {
  id               String  @id @default(cuid())
  budgetHeaderId   String
  accountSubjectId String
  month01          Decimal @default(0) @db.Decimal(15, 2)
  month02          Decimal @default(0) @db.Decimal(15, 2)
  month03          Decimal @default(0) @db.Decimal(15, 2)
  month04          Decimal @default(0) @db.Decimal(15, 2)
  month05          Decimal @default(0) @db.Decimal(15, 2)
  month06          Decimal @default(0) @db.Decimal(15, 2)
  month07          Decimal @default(0) @db.Decimal(15, 2)
  month08          Decimal @default(0) @db.Decimal(15, 2)
  month09          Decimal @default(0) @db.Decimal(15, 2)
  month10          Decimal @default(0) @db.Decimal(15, 2)
  month11          Decimal @default(0) @db.Decimal(15, 2)
  month12          Decimal @default(0) @db.Decimal(15, 2)
  totalAmount      Decimal @default(0) @db.Decimal(15, 2)

  budgetHeader   BudgetHeader   @relation(fields: [budgetHeaderId], references: [id], onDelete: Cascade)
  accountSubject AccountSubject @relation(fields: [accountSubjectId], references: [id])

  @@unique([budgetHeaderId, accountSubjectId])
  @@map("budget_details")
}

// ============================================================
// 재고 (Inventory)
// ============================================================

model ItemCategory {
  id       String  @id @default(cuid())
  code     String  @unique
  name     String
  parentId String?
  level    Int     @default(1)

  parent   ItemCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ItemCategory[] @relation("CategoryHierarchy")
  items    Item[]

  @@map("item_categories")
}

enum ItemType {
  RAW_MATERIAL
  PRODUCT
  GOODS
  SUBSIDIARY
}

enum TaxType {
  TAXABLE
  TAX_FREE
  ZERO_RATE
}

model Item {
  id            String   @id @default(cuid())
  itemCode      String   @unique
  itemName      String
  specification String?
  categoryId    String?
  unit          String   @default("EA")
  standardPrice Decimal  @default(0) @db.Decimal(15, 2)
  safetyStock   Int      @default(0)
  itemType      ItemType @default(GOODS)
  taxType       TaxType  @default(TAXABLE)
  barcode       String?  @unique
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category               ItemCategory?         @relation(fields: [categoryId], references: [id])
  stockMovementDetails   StockMovementDetail[]
  stockBalances          StockBalance[]
  quotationDetails       QuotationDetail[]
  salesOrderDetails      SalesOrderDetail[]
  deliveryDetails        DeliveryDetail[]
  purchaseRequestDetails PurchaseRequestDetail[]
  purchaseOrderDetails   PurchaseOrderDetail[]
  receivingDetails       ReceivingDetail[]

  @@index([itemName])
  @@index([isActive, itemType])
  @@map("items")
}

model Warehouse {
  id        String  @id @default(cuid())
  code      String  @unique
  name      String
  location  String?
  managerId String?
  isActive  Boolean @default(true)

  zones              WarehouseZone[]
  stockMovementsFrom StockMovement[] @relation("SourceWarehouse")
  stockMovementsTo   StockMovement[] @relation("TargetWarehouse")
  stockBalances      StockBalance[]

  @@map("warehouses")
}

model WarehouseZone {
  id          String @id @default(cuid())
  warehouseId String
  zoneCode    String
  zoneName    String

  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id])
  stockBalances StockBalance[]

  @@unique([warehouseId, zoneCode])
  @@map("warehouse_zones")
}

enum MovementType {
  INBOUND
  OUTBOUND
  TRANSFER
  ADJUSTMENT
}

model StockMovement {
  id                String       @id @default(cuid())
  movementNo        String       @unique
  movementDate      DateTime     @db.Date
  movementType      MovementType
  sourceWarehouseId String?
  targetWarehouseId String?
  relatedDocType    String?
  relatedDocId      String?
  status            String       @default("COMPLETED")
  createdBy         String
  createdAt         DateTime     @default(now())

  sourceWarehouse Warehouse?          @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id])
  targetWarehouse Warehouse?          @relation("TargetWarehouse", fields: [targetWarehouseId], references: [id])
  details         StockMovementDetail[]

  @@index([movementDate])
  @@index([movementType, movementDate])
  @@map("stock_movements")
}

model StockMovementDetail {
  id              String    @id @default(cuid())
  stockMovementId String
  itemId          String
  quantity        Decimal   @db.Decimal(15, 2)
  unitPrice       Decimal   @default(0) @db.Decimal(15, 2)
  amount          Decimal   @default(0) @db.Decimal(15, 2)
  lotNo           String?
  expiryDate      DateTime? @db.Date

  stockMovement StockMovement @relation(fields: [stockMovementId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])

  @@index([stockMovementId])
  @@index([itemId])
  @@map("stock_movement_details")
}

model StockBalance {
  id               String    @id @default(cuid())
  itemId           String
  warehouseId      String
  zoneId           String?
  quantity         Decimal   @default(0) @db.Decimal(15, 2)
  averageCost      Decimal   @default(0) @db.Decimal(15, 2)
  lastMovementDate DateTime?

  item      Item           @relation(fields: [itemId], references: [id])
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])
  zone      WarehouseZone? @relation(fields: [zoneId], references: [id])

  @@unique([itemId, warehouseId, zoneId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("stock_balances")
}

// ============================================================
// 영업 (Sales) + 거래처
// ============================================================

enum PartnerType {
  SALES
  PURCHASE
  BOTH
}

model Partner {
  id            String      @id @default(cuid())
  partnerCode   String      @unique
  partnerName   String
  partnerType   PartnerType  @default(BOTH)
  salesChannel  SalesChannel @default(OFFLINE)
  bizNo         String?
  ceoName       String?
  bizType       String?
  bizCategory   String?
  phone         String?
  fax           String?
  email         String?
  address       String?
  contactPerson String?
  creditLimit   Decimal?    @db.Decimal(15, 2)
  paymentTerms  String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  quotations       Quotation[]
  salesOrders      SalesOrder[]
  deliveries       Delivery[]
  purchaseOrders   PurchaseOrder[]
  receivings       Receiving[]
  voucherDetails   VoucherDetail[]
  taxInvoices      TaxInvoice[]
  purchasePayments PurchasePayment[]

  @@index([partnerName])
  @@index([bizNo])
  @@index([isActive, partnerType])
  @@map("partners")
}

enum QuotationStatus {
  DRAFT
  SUBMITTED
  ORDERED
  LOST
  CANCELLED
}

model Quotation {
  id            String          @id @default(cuid())
  quotationNo   String          @unique
  quotationDate DateTime        @db.Date
  partnerId     String
  validUntil    DateTime?       @db.Date
  totalSupply   Decimal         @default(0) @db.Decimal(15, 2)
  totalTax      Decimal         @default(0) @db.Decimal(15, 2)
  totalAmount   Decimal         @default(0) @db.Decimal(15, 2)
  status        QuotationStatus @default(DRAFT)
  employeeId    String
  description   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  partner     Partner           @relation(fields: [partnerId], references: [id])
  employee    Employee          @relation(fields: [employeeId], references: [id])
  details     QuotationDetail[]
  salesOrders SalesOrder[]

  @@index([quotationDate])
  @@index([partnerId])
  @@index([status])
  @@index([employeeId])
  @@map("quotations")
}

model QuotationDetail {
  id           String  @id @default(cuid())
  quotationId  String
  lineNo       Int
  itemId       String
  quantity     Decimal @db.Decimal(15, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  supplyAmount Decimal @db.Decimal(15, 2)
  taxAmount    Decimal @db.Decimal(15, 2)
  totalAmount  Decimal @db.Decimal(15, 2)
  remark       String?

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [id])

  @@map("quotation_details")
}

enum SalesOrderStatus {
  ORDERED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SalesChannel {
  ONLINE
  OFFLINE
}

model SalesOrder {
  id            String           @id @default(cuid())
  orderNo       String           @unique
  orderDate     DateTime         @db.Date
  partnerId     String
  quotationId   String?
  deliveryDate  DateTime?        @db.Date
  salesChannel  SalesChannel     @default(OFFLINE)
  totalSupply   Decimal          @default(0) @db.Decimal(15, 2)
  totalTax      Decimal          @default(0) @db.Decimal(15, 2)
  totalAmount   Decimal          @default(0) @db.Decimal(15, 2)
  status        SalesOrderStatus @default(ORDERED)
  employeeId    String
  description   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  partner    Partner            @relation(fields: [partnerId], references: [id])
  quotation  Quotation?         @relation(fields: [quotationId], references: [id])
  employee   Employee           @relation(fields: [employeeId], references: [id])
  details    SalesOrderDetail[]
  deliveries Delivery[]

  @@index([orderDate])
  @@index([status])
  @@index([status, salesChannel])
  @@index([partnerId])
  @@index([status, createdAt])
  @@index([employeeId])
  @@index([orderDate, status])
  @@map("sales_orders")
}

model SalesOrderDetail {
  id           String  @id @default(cuid())
  salesOrderId String
  lineNo       Int
  itemId       String
  quantity     Decimal @db.Decimal(15, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  supplyAmount Decimal @db.Decimal(15, 2)
  taxAmount    Decimal @db.Decimal(15, 2)
  totalAmount  Decimal @db.Decimal(15, 2)
  deliveredQty Decimal @default(0) @db.Decimal(15, 2)
  remainingQty Decimal @db.Decimal(15, 2)
  remark       String?

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [id])

  @@index([salesOrderId])
  @@index([itemId])
  @@map("sales_order_details")
}

model Delivery {
  id              String   @id @default(cuid())
  deliveryNo      String   @unique
  deliveryDate    DateTime @db.Date
  salesOrderId    String
  partnerId       String
  status          String   @default("PREPARING")
  deliveryAddress String?
  trackingNo      String?
  carrier         String?
  createdAt       DateTime @default(now())

  salesOrder SalesOrder     @relation(fields: [salesOrderId], references: [id])
  partner    Partner        @relation(fields: [partnerId], references: [id])
  details    DeliveryDetail[]

  @@index([deliveryDate])
  @@index([salesOrderId])
  @@map("deliveries")
}

model DeliveryDetail {
  id              String  @id @default(cuid())
  deliveryId      String
  itemId          String
  quantity        Decimal @db.Decimal(15, 2)
  unitPrice       Decimal @db.Decimal(15, 2)
  amount          Decimal @db.Decimal(15, 2)
  stockMovementId String?

  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id])

  @@index([deliveryId])
  @@map("delivery_details")
}

// ============================================================
// 구매 (Procurement)
// ============================================================

model PurchaseRequest {
  id           String   @id @default(cuid())
  requestNo    String   @unique
  requestDate  DateTime @db.Date
  departmentId String
  requesterId  String
  reason       String?
  status       String   @default("REQUESTED")
  approvalId   String?
  createdAt    DateTime @default(now())

  department Department               @relation(fields: [departmentId], references: [id])
  details    PurchaseRequestDetail[]

  @@index([requestDate])
  @@map("purchase_requests")
}

model PurchaseRequestDetail {
  id                String    @id @default(cuid())
  purchaseRequestId String
  itemId            String
  quantity          Decimal   @db.Decimal(15, 2)
  desiredDate       DateTime? @db.Date
  remark            String?

  purchaseRequest PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  item            Item            @relation(fields: [itemId], references: [id])

  @@map("purchase_request_details")
}

model PurchaseOrder {
  id                String    @id @default(cuid())
  orderNo           String    @unique
  orderDate         DateTime  @db.Date
  partnerId         String
  purchaseRequestId String?
  deliveryDate      DateTime? @db.Date
  totalSupply       Decimal   @default(0) @db.Decimal(15, 2)
  totalTax          Decimal   @default(0) @db.Decimal(15, 2)
  totalAmount       Decimal   @default(0) @db.Decimal(15, 2)
  status            String    @default("ORDERED")
  employeeId        String
  description       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  partner    Partner               @relation(fields: [partnerId], references: [id])
  employee   Employee              @relation(fields: [employeeId], references: [id])
  details    PurchaseOrderDetail[]
  receivings Receiving[]

  @@index([orderDate])
  @@index([partnerId])
  @@index([status])
  @@index([employeeId])
  @@map("purchase_orders")
}

model PurchaseOrderDetail {
  id              String  @id @default(cuid())
  purchaseOrderId String
  lineNo          Int
  itemId          String
  quantity        Decimal @db.Decimal(15, 2)
  unitPrice       Decimal @db.Decimal(15, 2)
  supplyAmount    Decimal @db.Decimal(15, 2)
  taxAmount       Decimal @db.Decimal(15, 2)
  amount          Decimal @db.Decimal(15, 2)
  receivedQty     Decimal @default(0) @db.Decimal(15, 2)
  remainingQty    Decimal @db.Decimal(15, 2)
  remark          String?

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_details")
}

model Receiving {
  id              String   @id @default(cuid())
  receivingNo     String   @unique
  receivingDate   DateTime @db.Date
  purchaseOrderId String
  partnerId       String
  status          String   @default("RECEIVED")
  inspectedBy     String?
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id])
  partner       Partner         @relation(fields: [partnerId], references: [id])
  details       ReceivingDetail[]

  @@index([receivingDate])
  @@map("receivings")
}

model ReceivingDetail {
  id              String  @id @default(cuid())
  receivingId     String
  itemId          String
  orderedQty      Decimal @db.Decimal(15, 2)
  receivedQty     Decimal @db.Decimal(15, 2)
  acceptedQty     Decimal @db.Decimal(15, 2)
  rejectedQty     Decimal @default(0) @db.Decimal(15, 2)
  unitPrice       Decimal @db.Decimal(15, 2)
  amount          Decimal @db.Decimal(15, 2)
  stockMovementId String?

  receiving Receiving @relation(fields: [receivingId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [id])

  @@index([receivingId])
  @@map("receiving_details")
}

model PurchasePayment {
  id            String   @id @default(cuid())
  paymentNo     String   @unique
  paymentDate   DateTime @db.Date
  partnerId     String
  totalAmount   Decimal  @db.Decimal(15, 2)
  paymentMethod String?
  status        String   @default("PENDING")
  voucherId     String?
  description   String?
  createdAt     DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])

  @@map("purchase_payments")
}

// ============================================================
// 프로젝트 (Project)
// ============================================================

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model Project {
  id           String        @id @default(cuid())
  projectCode  String        @unique
  projectName  String
  managerId    String
  departmentId String
  startDate    DateTime      @db.Date
  endDate      DateTime?     @db.Date
  budget       Decimal?      @db.Decimal(15, 2)
  status       ProjectStatus @default(PLANNING)
  progress     Decimal       @default(0) @db.Decimal(5, 2)
  description  String?       @db.Text
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  department Department      @relation(fields: [departmentId], references: [id])
  members    ProjectMember[]
  tasks      ProjectTask[]
  schedules  ProjectSchedule[]

  @@map("projects")
}

enum ProjectMemberRole {
  PM
  MEMBER
  REVIEWER
}

model ProjectMember {
  id         String            @id @default(cuid())
  projectId  String
  employeeId String
  role       ProjectMemberRole @default(MEMBER)

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([projectId, employeeId])
  @@map("project_members")
}

enum TaskPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum TaskStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

model ProjectTask {
  id             String       @id @default(cuid())
  projectId      String
  taskName       String
  assigneeId     String?
  parentTaskId   String?
  startDate      DateTime?    @db.Date
  endDate        DateTime?    @db.Date
  priority       TaskPriority @default(NORMAL)
  status         TaskStatus   @default(WAITING)
  progress       Decimal      @default(0) @db.Decimal(5, 2)
  estimatedHours Decimal?     @db.Decimal(8, 2)
  actualHours    Decimal?     @db.Decimal(8, 2)
  description    String?
  createdAt      DateTime     @default(now())

  project    Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentTask ProjectTask?  @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subTasks   ProjectTask[] @relation("TaskHierarchy")

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@map("project_tasks")
}

model ProjectSchedule {
  id            String   @id @default(cuid())
  projectId     String
  title         String
  startDateTime DateTime
  endDateTime   DateTime
  type          String   @default("SCHEDULE")
  description   String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_schedules")
}

// ============================================================
// 전자결재 (Approval)
// ============================================================

model ApprovalTemplate {
  id           String  @id @default(cuid())
  templateName String
  moduleCode   String
  formSchema   Json?
  isActive     Boolean @default(true)

  approvalLines ApprovalLine[]
  documents     ApprovalDocument[]

  @@map("approval_templates")
}

model ApprovalLine {
  id               String @id @default(cuid())
  templateId       String
  lineOrder        Int
  approverType     String
  approverId       String?
  approverPosition String?
  approvalType     String @default("APPROVE")

  template ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("approval_lines")
}

enum ApprovalStatus {
  DRAFTED
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

model ApprovalDocument {
  id            String         @id @default(cuid())
  documentNo    String         @unique
  templateId    String?
  title         String
  content       Json?
  drafterId     String
  draftDate     DateTime       @db.Date
  currentStep   Int            @default(0)
  totalSteps    Int            @default(0)
  status        ApprovalStatus @default(DRAFTED)
  relatedModule String?
  relatedDocId  String?
  urgency       String         @default("NORMAL")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  template ApprovalTemplate? @relation(fields: [templateId], references: [id])
  drafter  Employee           @relation("Drafter", fields: [drafterId], references: [id])
  steps    ApprovalStep[]

  @@index([status])
  @@index([drafterId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("approval_documents")
}

enum StepStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

model ApprovalStep {
  id           String     @id @default(cuid())
  documentId   String
  stepOrder    Int
  approverId   String
  approvalType String     @default("APPROVE")
  status       StepStatus @default(PENDING)
  comment      String?
  actionDate   DateTime?

  document ApprovalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  approver Employee         @relation(fields: [approverId], references: [id])

  @@index([approverId, status])
  @@index([documentId, stepOrder])
  @@map("approval_steps")
}

// ============================================================
// 게시판 (Board)
// ============================================================

model Board {
  id        String  @id @default(cuid())
  boardCode String  @unique
  boardName String
  boardType String  @default("GENERAL")
  isActive  Boolean @default(true)

  posts Post[]

  @@map("boards")
}

model Post {
  id        String   @id @default(cuid())
  boardId   String
  title     String
  content   String   @db.Text
  authorId  String
  isPinned  Boolean  @default(false)
  viewCount Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board    Board         @relation(fields: [boardId], references: [id])
  author   User          @relation(fields: [authorId], references: [id])
  comments PostComment[]

  @@index([boardId, createdAt])
  @@index([authorId])
  @@map("posts")
}

model PostComment {
  id              String   @id @default(cuid())
  postId          String
  authorId        String
  content         String
  parentCommentId String?
  createdAt       DateTime @default(now())

  post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User          @relation(fields: [authorId], references: [id])
  parentComment PostComment?  @relation("CommentHierarchy", fields: [parentCommentId], references: [id])
  replies       PostComment[] @relation("CommentHierarchy")

  @@index([postId])
  @@map("post_comments")
}

model Message {
  id         String    @id @default(cuid())
  senderId   String
  receiverId String
  subject    String
  content    String    @db.Text
  isRead     Boolean   @default(false)
  readAt     DateTime?
  sentAt     DateTime  @default(now())

  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([receiverId, isRead])
  @@index([senderId, sentAt])
  @@map("messages")
}
